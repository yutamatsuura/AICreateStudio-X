# AICreateStudio-X - 要件定義書

要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

## 1. プロジェクト概要

### 1.1 成果目標
AI会話型のコンテンツ生成プラットフォームを構築し、ペルソナ・テーマ・文章・画像・プロンプトを統合的に生成できる有料SaaSとしてエンドユーザーに提供。WordPress自動投稿など実用機能で継続課金を実現する。

### 1.2 成功指標

#### 定量的指標
- 月間有料ユーザー数: 50名以上（リリース後3ヶ月）
- Proプランの継続率: 月次解約率5%以下（年間継続率80%以上）
- 1ユーザーあたりのプロジェクト作成数: 平均5プロジェクト/月以上
- WordPress自動投稿成功率: 95%以上
- トライアルからProプランへの転換率: 20%以上

#### 定性的指標
- ユーザーが「会話しながら作れる楽しさ」を実感できる：チャット形式の直感的な操作で迷わず生成できる
- プロジェクト間の連携がスムーズ：ペルソナ→テーマ→文章の流れが自然で、データの再利用が快適
- WordPress投稿が本当にワンクリック：設定さえすれば、生成からブログ投稿までシームレス
- GammaライクなUIで「使いたくなる」：視覚的に美しく、ワクワクするダッシュボード体験
- 専門性の調整が効いている：初心者向け〜専門家向けまでトーン調整が実感できる
- 有料でも「価値がある」と感じてもらえる：AIコンテンツ生成の品質と効率性が料金以上の価値を提供

## 2. システム全体像

### 2.1 主要機能一覧
- **ペルソナ生成**: AIとの会話（音声/テキスト）で自分のペルソナ、ターゲットペルソナを生成
- **テーマ生成**: ファイルアップロード、テキスト貼り付け、Webリンク入力からAIがテーマを複数生成
- **文章生成**: ジャンル別初期プロンプト、テーマ/ペルソナ参照、SEO対応、画像差し込み、WordPress自動投稿
- **画像生成**: AIとの会話で画像生成（2パターン）、スタイル/縦横比指定、修正依頼でブラッシュアップ
- **プロンプト生成**: AIとの会話でカスタムプロンプト生成
- **管理機能**: ユーザー管理、システム設定、データ分析、サポート管理

### 2.2 ユーザーロールと権限

- **一般ユーザー（Pro/トライアル）**: プラットフォームの主要利用者（個人ブロガー、マーケター、コンテンツクリエイター）
  - 全機能利用可能（ペルソナ、テーマ、文章、画像、プロンプト生成、WordPress投稿）
  - 自分のプロジェクトのみ閲覧・編集可能
  - トライアル: 14日間無料（クレカ登録必須）
  - Pro: 有料プラン（月額/年額）

- **管理者（Admin）**: システム運営者
  - 全ユーザーのプロジェクト閲覧可能（サポート・モニタリング用）
  - ユーザー管理、システム設定、データ分析、サポート対応

### 2.3 認証・認可要件

- **認証方式**:
  - Google OAuth認証（ワンクリックログイン）
  - メール + パスワード認証（従来型）
  - パスワードリセット機能（メール送信）
  - メール認証（確認メール送信）: 不要
  - 2段階認証（2FA）: 不要

- **セキュリティレベル**:
  - 個人情報（氏名、メールアドレス、プロジェクトデータ）
  - 決済情報（Stripe管理、PCI DSS準拠）
  - HTTPS必須（本番環境）
  - セッション管理（Cookie-based、Auth.js v5）

- **管理機能**:
  - ユーザー管理（登録承認、削除、権限変更、サブスク状態確認）
  - システム設定（料金プラン変更、メール通知設定）
  - データ分析（利用統計、売上、人気機能分析）
  - サポート機能（問い合わせ対応、フィードバック管理）

## 3. ページ詳細仕様

### 3.1 P-001: ログイン/サインアップ

#### 目的
ユーザー認証でプラットフォームへアクセス

#### 主要機能
- Google OAuthログイン
- メール + パスワードログイン
- メール + パスワード新規登録
- パスワードリセットリンク

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ログイン状態確認 | セッションCookie | ユーザー情報 |
| 作成 | 新規ユーザー登録 | メール、パスワード、名前 | ユーザーアカウント作成 |
| 作成 | Google OAuthログイン | Google認証情報 | セッション生成 |
| 作成 | メール/パスワードログイン | メール、パスワード | セッション生成 |

#### 処理フロー
1. ユーザーがログイン/サインアップページにアクセス
2. Google OAuthまたはメール/パスワードで認証
3. 認証成功後、ダッシュボード（U-001）へリダイレクト
4. 新規登録の場合、初回セットアップ（OpenAI APIキー設定）を案内

#### データ構造（概念）
```yaml
User:
  識別子: user_id（UUID）
  基本情報:
    - name（必須）
    - email（必須、ユニーク）
    - password_hash（メール/パスワード認証時のみ）
    - oauth_provider（Google等）
    - oauth_id（OAuth認証時のみ）
  メタ情報:
    - created_at
    - updated_at
  関連:
    - Subscription（1対1）
    - Projects（1対多）
```

---

### 3.2 P-002: パスワードリセット

#### 目的
パスワード忘れユーザーの再設定

#### 主要機能
- メールアドレス入力でリセットリンク送信
- リセットトークン検証
- 新パスワード設定

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | リセットリンク送信 | メールアドレス | リセットトークン生成、メール送信 |
| 更新 | パスワード更新 | リセットトークン、新パスワード | パスワード更新完了 |

#### 処理フロー
1. ユーザーがメールアドレスを入力
2. システムがリセットトークンを生成、メール送信
3. ユーザーがメール内のリンクをクリック
4. 新パスワード入力、更新完了

---

### 3.3 U-001: ダッシュボード

#### 目的
全プロジェクトを一覧表示、各生成機能への導線

#### 主要機能
- 最近のプロジェクト一覧（ペルソナ、テーマ、文章、画像、プロンプト）
- 各生成機能へのクイックアクセス
- サブスクリプション状態表示（トライアル残日数、Proプラン）
- お知らせ・通知表示

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 最近のプロジェクト一覧 | user_id | 全カテゴリのプロジェクト一覧（最新10件） |
| 取得 | サブスクリプション状態 | user_id | トライアル残日数/Proプラン情報 |

#### 処理フロー
1. ユーザーがログイン後、ダッシュボードにアクセス
2. 最近のプロジェクトを表示（各カテゴリから最新を抽出）
3. サブスクリプション状態を表示
4. 各生成機能へのボタンをクリックでワークスペースへ遷移

---

### 3.4 U-002: ペルソナ生成ワークスペース

#### 目的
ペルソナプロジェクト一覧の管理・新規作成導線

#### 主要機能
- ペルソナプロジェクト一覧表示
- 検索・フィルター（自分のペルソナ/ターゲットペルソナ）
- 新規ペルソナ生成ボタン
- プロジェクト削除（ゴミ箱へ移動）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ペルソナ一覧取得 | user_id | ペルソナプロジェクト一覧 |
| 削除 | プロジェクト削除 | project_id | ゴミ箱へ移動 |

#### 処理フロー
1. ユーザーがペルソナ生成メニューをクリック
2. 既存プロジェクトがある場合: ワークスペース表示
3. 既存プロジェクトがない場合: 直接U-003（ペルソナ生成）へ遷移
4. 新規作成ボタンクリックでU-003へ遷移

---

### 3.5 U-003: ペルソナ生成（会話）

#### 目的
AIとの会話でペルソナ生成

#### 主要機能
- ペルソナタイプ選択（自分のペルソナ/ターゲットペルソナ）
- 音声入力/テキスト入力切り替え
- AIとの会話インターフェース
- 会話終了後、自動ペルソナ生成
- 生成結果の編集・保存

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 会話メッセージ送信 | user_message（テキスト/音声） | AI応答 |
| 作成 | ペルソナ生成 | 会話履歴 | ペルソナデータ（JSON） |
| 更新 | ペルソナ編集 | project_id, 編集内容 | ペルソナ更新 |

#### 処理フロー
1. ユーザーがペルソナタイプを選択
2. AIとの会話開始（音声/テキスト）
3. 会話終了ボタンをクリック
4. AIが会話履歴を分析、ペルソナを自動生成
5. 生成結果を表示、ユーザーが編集可能
6. 保存後、他のプロジェクト（文章生成等）で参照可能

#### データ構造（概念）
```yaml
PersonaProject:
  識別子: project_id（UUID）
  基本情報:
    - user_id（外部キー）
    - persona_type（自分/ターゲット）
    - name（ペルソナ名）
    - data（ペルソナ詳細、JSON形式）
  メタ情報:
    - created_at
    - updated_at
    - is_deleted（ゴミ箱フラグ）
```

---

### 3.6 U-004: テーマ生成ワークスペース

#### 目的
テーマプロジェクト一覧の管理・新規作成導線

#### 主要機能
- テーマプロジェクト一覧表示
- 検索・フィルター
- 新規テーマ生成ボタン
- プロジェクト削除（ゴミ箱へ移動）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | テーマ一覧取得 | user_id | テーマプロジェクト一覧 |
| 削除 | プロジェクト削除 | project_id | ゴミ箱へ移動 |

#### 処理フロー
1. ユーザーがテーマ生成メニューをクリック
2. 既存プロジェクトがある場合: ワークスペース表示
3. 既存プロジェクトがない場合: 直接U-005（テーマ生成）へ遷移
4. 新規作成ボタンクリックでU-005へ遷移

---

### 3.7 U-005: テーマ生成（ソース入力→生成）

#### 目的
ファイル/URL/テキスト入力でテーマ生成

#### 主要機能
- 方向性入力（テキストエリア）
- ファイルアップロード（PDF, .txt, Markdown, 音声, .docx, 画像等）
- テキスト貼り付け入力
- Webリンク入力
- ペルソナ参照（オプション）
- 生成数指定（1〜10個）
- 専門性レベル設定（初心者/中級/専門家）
- テーマ一覧表示・編集

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | ファイルアップロード | ファイル | テキスト抽出 |
| 作成 | Webリンク解析 | URL | コンテンツ抽出 |
| 作成 | テーマ生成 | ソースデータ、生成数、専門性 | テーマリスト |
| 更新 | テーマ編集 | project_id, テーマ内容 | テーマ更新 |

#### 処理フロー
1. ユーザーがソース入力（ファイル/テキスト/リンク）
2. オプションでペルソナ参照を選択
3. 生成数、専門性レベルを設定
4. AIがソースを解析、テーマを複数生成
5. テーマ一覧を表示、ユーザーが編集可能
6. 保存後、文章生成で参照可能

#### データ構造（概念）
```yaml
ThemeProject:
  識別子: project_id（UUID）
  基本情報:
    - user_id（外部キー）
    - source_type（ファイル/テキスト/リンク）
    - source_data（ソース内容）
    - persona_id（参照ペルソナ、オプション）
    - theme_count（生成数）
    - expertise_level（専門性レベル）
    - themes（テーマリスト、JSON配列）
  メタ情報:
    - created_at
    - updated_at
    - is_deleted（ゴミ箱フラグ）
```

---

### 3.8 U-006: 文章生成ワークスペース

#### 目的
文章プロジェクト一覧の管理・新規作成導線

#### 主要機能
- 文章プロジェクト一覧表示
- 検索・フィルター（ジャンル別）
- 新規文章生成ボタン
- プロジェクト削除（ゴミ箱へ移動）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 文章一覧取得 | user_id | 文章プロジェクト一覧 |
| 削除 | プロジェクト削除 | project_id | ゴミ箱へ移動 |

#### 処理フロー
1. ユーザーが文章生成メニューをクリック
2. 既存プロジェクトがある場合: ワークスペース表示
3. 既存プロジェクトがない場合: 直接U-007（文章生成）へ遷移
4. 新規作成ボタンクリックでU-007へ遷移

---

### 3.9 U-007: 文章生成（設定→生成→編集）

#### 目的
ジャンル選択、設定、AI生成、編集、WordPress投稿

#### 主要機能
- ジャンル選択（記事コンテンツ、SNS投稿、動画台本、セールスページ、ステップメール等）
- ジャンル別初期プロンプト自動適用
- 文章トーン設定（フォーマル/カジュアル等）
- テーマ参照（テーマ生成で作成したテーマを選択）
- 手動テーマ入力
- 執筆者ペルソナ設定（ペルソナ生成で作成したペルソナを選択）
- ターゲットペルソナ設定（ペルソナ生成で作成したペルソナを選択）
- SEO設定（キーワード、メタディスクリプション）
- AI文章生成
- リッチテキストエディタで編集
- 画像差し込み（GPT Image 1.5生成）
- WordPress自動投稿（下書き/本番投稿）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ジャンル別初期プロンプト取得 | genre | 初期プロンプトテンプレート |
| 取得 | テーマ一覧取得 | user_id | テーマプロジェクト一覧 |
| 取得 | ペルソナ一覧取得 | user_id | ペルソナプロジェクト一覧 |
| 作成 | 文章生成 | 設定内容（ジャンル、テーマ、ペルソナ等） | AI生成文章 |
| 作成 | 画像生成（差し込み用） | プロンプト、スタイル、縦横比 | 画像URL |
| 作成 | WordPress投稿 | 文章、画像、WordPress設定 | 投稿成功/失敗 |
| 更新 | 文章編集 | project_id, 編集内容 | 文章更新 |

#### 処理フロー
1. ユーザーがジャンルを選択
2. ジャンル別初期プロンプトが自動適用
3. 文章トーン、テーマ、ペルソナ、SEO設定を入力
4. AI生成ボタンをクリック
5. AIが文章を生成、リッチテキストエディタに表示
6. ユーザーが編集、画像差し込み位置を指定
7. 画像生成（GPT Image 1.5）を実行、差し込み
8. WordPress自動投稿（オプション）:
   - WordPress設定（URL、Application Password）を確認
   - アイキャッチ画像、カテゴリ、パーマリンク、タイトル設定
   - 下書き/本番投稿を選択
9. 保存完了

#### データ構造（概念）
```yaml
ArticleProject:
  識別子: project_id（UUID）
  基本情報:
    - user_id（外部キー）
    - genre（ジャンル）
    - tone（文章トーン）
    - theme（テーマ、手動入力またはtheme_id参照）
    - author_persona_id（執筆者ペルソナ、オプション）
    - target_persona_id（ターゲットペルソナ、オプション）
    - seo_keywords（SEOキーワード配列）
    - seo_meta_description（メタディスクリプション）
    - content（生成文章、HTML）
    - images（差し込み画像URL配列）
  WordPress設定:
    - wordpress_url（投稿先URL）
    - wordpress_status（下書き/本番）
    - wordpress_category_id（カテゴリID）
    - wordpress_permalink（パーマリンク）
    - wordpress_featured_image（アイキャッチ画像URL）
  メタ情報:
    - created_at
    - updated_at
    - is_deleted（ゴミ箱フラグ）
```

---

### 3.10 U-008: 画像生成ワークスペース

#### 目的
画像プロジェクト一覧の管理・新規作成導線

#### 主要機能
- 画像プロジェクト一覧表示
- 検索・フィルター
- 新規画像生成ボタン
- プロジェクト削除（ゴミ箱へ移動）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 画像一覧取得 | user_id | 画像プロジェクト一覧 |
| 削除 | プロジェクト削除 | project_id | ゴミ箱へ移動 |

#### 処理フロー
1. ユーザーが画像生成メニューをクリック
2. 既存プロジェクトがある場合: ワークスペース表示
3. 既存プロジェクトがない場合: 直接U-009（画像生成）へ遷移
4. 新規作成ボタンクリックでU-009へ遷移

---

### 3.11 U-009: 画像生成（会話）

#### 目的
AIとの会話で画像生成（2パターン）

#### 主要機能
- スタイル選択（リアル、イラスト、抽象等）
- 縦横比選択（正方形、横長、縦長）
- 音声入力/テキスト入力切り替え
- AIとの会話インターフェース
- 2パターン画像生成（並列リクエスト）
- パターン選択、修正依頼
- 修正後の画像生成
- 画像保存（文章生成で利用可能）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 会話メッセージ送信 | user_message（テキスト/音声） | AI応答 |
| 作成 | 画像生成（2パターン） | プロンプト、スタイル、縦横比 | 画像URL×2 |
| 作成 | 修正依頼・再生成 | 選択画像、修正指示 | 修正後画像URL |
| 更新 | 画像保存 | project_id, 画像URL | 画像プロジェクト更新 |

#### 処理フロー
1. ユーザーがスタイル、縦横比を選択
2. AIとの会話で画像イメージを伝える（音声/テキスト）
3. AIが2パターンの画像を並列生成（GPT Image 1.5）
4. 2パターンを表示、ユーザーが1つ選択
5. 選択後、修正依頼を会話で入力
6. AIが修正後の画像を生成
7. 満足したら保存、文章生成プロジェクトで利用可能

#### データ構造（概念）
```yaml
ImageProject:
  識別子: project_id（UUID）
  基本情報:
    - user_id（外部キー）
    - style（スタイル）
    - aspect_ratio（縦横比）
    - prompt（最終プロンプト）
    - image_url（最終画像URL）
    - variants（生成バリエーション履歴、JSON配列）
  メタ情報:
    - created_at
    - updated_at
    - is_deleted（ゴミ箱フラグ）
```

---

### 3.12 U-010: プロンプト生成ワークスペース

#### 目的
プロンプトプロジェクト一覧の管理・新規作成導線

#### 主要機能
- プロンプトプロジェクト一覧表示
- 検索・フィルター
- 新規プロンプト生成ボタン
- プロジェクト削除（ゴミ箱へ移動）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | プロンプト一覧取得 | user_id | プロンプトプロジェクト一覧 |
| 削除 | プロジェクト削除 | project_id | ゴミ箱へ移動 |

#### 処理フロー
1. ユーザーがプロンプト生成メニューをクリック
2. 既存プロジェクトがある場合: ワークスペース表示
3. 既存プロジェクトがない場合: 直接U-011（プロンプト生成）へ遷移
4. 新規作成ボタンクリックでU-011へ遷移

---

### 3.13 U-011: プロンプト生成（会話）

#### 目的
AIとの会話でカスタムプロンプト生成

#### 主要機能
- 初期プロンプト（プロンプト生成用）をベースにAIと会話
- 音声入力/テキスト入力切り替え
- AIとの会話インターフェース
- カスタムプロンプト生成
- 生成結果の編集・保存

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 会話メッセージ送信 | user_message（テキスト/音声） | AI応答 |
| 作成 | プロンプト生成 | 会話履歴 | カスタムプロンプト |
| 更新 | プロンプト編集 | project_id, 編集内容 | プロンプト更新 |

#### 処理フロー
1. ユーザーが希望するプロンプトの用途を会話で伝える
2. AIが会話を通じてプロンプトを生成
3. 生成結果を表示、ユーザーが編集可能
4. 保存完了

#### データ構造（概念）
```yaml
PromptProject:
  識別子: project_id（UUID）
  基本情報:
    - user_id（外部キー）
    - purpose（用途）
    - prompt（生成プロンプト）
  メタ情報:
    - created_at
    - updated_at
    - is_deleted（ゴミ箱フラグ）
```

---

### 3.14 U-012: ゴミ箱

#### 目的
削除済みプロジェクト管理

#### 主要機能
- 削除済みプロジェクト一覧表示（全カテゴリ）
- プロジェクト復元
- 完全削除

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ゴミ箱一覧取得 | user_id | 削除済みプロジェクト一覧 |
| 更新 | プロジェクト復元 | project_id | is_deleted = false |
| 削除 | 完全削除 | project_id | プロジェクト削除 |

#### 処理フロー
1. ユーザーがゴミ箱メニューをクリック
2. 削除済みプロジェクト一覧を表示
3. 復元ボタンクリックで元のワークスペースに戻す
4. 完全削除ボタンクリックで永久削除

---

### 3.15 U-013: アカウント設定

#### 目的
ユーザー情報・API設定・WordPress設定

#### 主要機能
- プロフィール編集（名前、メールアドレス）
- パスワード変更
- **OpenAI APIキー設定**:
  - APIキー入力フィールド
  - 接続テスト機能
  - 使用量確認リンク（OpenAIダッシュボード）
- WordPress接続設定（URL、Application Password）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ユーザー情報取得 | user_id | ユーザー情報 |
| 更新 | プロフィール更新 | user_id, 名前、メール | ユーザー情報更新 |
| 更新 | パスワード変更 | user_id, 旧パスワード、新パスワード | パスワード更新 |
| 更新 | OpenAI APIキー設定 | user_id, api_key | APIキー暗号化保存 |
| 作成 | OpenAI APIキー接続テスト | api_key | 接続成功/失敗 |
| 更新 | WordPress設定 | user_id, wordpress_url, app_password | WordPress設定保存 |

#### 処理フロー
1. ユーザーがアカウント設定にアクセス
2. 各設定項目を編集
3. OpenAI APIキー設定:
   - APIキーを入力
   - 接続テストボタンクリック
   - OpenAI API経由で有効性確認
   - 成功後、暗号化して保存
4. WordPress設定:
   - WordPress URL、Application Passwordを入力
   - 接続テスト（REST API疎通確認）
   - 成功後、保存
5. 保存完了

---

### 3.16 U-014: サブスクリプション管理

#### 目的
プラン確認・アップグレード

#### 主要機能
- 現在のプラン表示（トライアル/Pro）
- トライアル残日数表示
- Proプランへのアップグレード（Stripe Checkout）
- サブスク履歴表示
- プラン変更・キャンセル（Stripe経由）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | サブスク情報取得 | user_id | プラン情報、トライアル残日数 |
| 作成 | Stripe Checkout開始 | user_id, plan | Checkout URL |
| 更新 | プラン変更 | user_id, new_plan | プラン更新（Stripe経由） |
| 削除 | サブスクキャンセル | user_id | サブスク解約（Stripe経由） |

#### 処理フロー
1. ユーザーがサブスクリプション管理にアクセス
2. 現在のプラン、トライアル残日数を表示
3. アップグレードボタンクリック
4. Stripe Checkoutページへリダイレクト
5. 決済完了後、Proプランにアップグレード
6. Webhook経由でサブスク状態を同期

---

### 3.17 U-015: お問い合わせ

#### 目的
管理者への問い合わせ送信

#### 主要機能
- 問い合わせフォーム（件名、本文）
- カテゴリ選択（技術的問題、請求、機能要望等）
- 添付ファイル（オプション）
- 送信後、管理者に通知

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 問い合わせ送信 | user_id, 件名、本文、カテゴリ | 問い合わせ登録、管理者通知 |

#### 処理フロー
1. ユーザーが問い合わせフォームに入力
2. 送信ボタンクリック
3. 管理者にメール通知
4. 問い合わせがA-005（サポート管理）に登録
5. 送信完了メッセージ表示

---

### 3.18 U-016: フィードバック

#### 目的
機能改善要望の送信

#### 主要機能
- フィードバックフォーム（タイトル、本文）
- カテゴリ選択（UI/UX、機能追加、バグ報告等）
- スクリーンショット添付（オプション）
- 送信後、管理者に通知

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | フィードバック送信 | user_id, タイトル、本文、カテゴリ | フィードバック登録、管理者通知 |

#### 処理フロー
1. ユーザーがフィードバックフォームに入力
2. 送信ボタンクリック
3. 管理者にメール通知
4. フィードバックがA-005（サポート管理）に登録
5. 送信完了メッセージ表示

---

### 3.19 A-001: 管理者ダッシュボード

#### 目的
統計サマリー・全体監視

#### 主要機能
- ユーザー数（トライアル/Pro）
- 売上推移グラフ
- 人気機能ランキング（ペルソナ/テーマ/文章/画像/プロンプト生成の利用率）
- アクティブプロジェクト数
- 最近の問い合わせ・フィードバック

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 統計データ取得 | - | ユーザー数、売上、利用率等 |

#### 処理フロー
1. 管理者がログイン後、ダッシュボードにアクセス
2. 統計データを可視化（グラフ、数値）
3. 最近の問い合わせ・フィードバックを表示

---

### 3.20 A-002: ユーザー管理

#### 目的
ユーザー一覧・編集・削除

#### 主要機能
- ユーザー一覧表示
- 検索・フィルター（トライアル/Pro、登録日等）
- サブスク状態確認
- 権限変更（一般ユーザー/管理者）
- アカウント削除

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ユーザー一覧取得 | - | 全ユーザー情報 |
| 更新 | 権限変更 | user_id, new_role | 権限更新 |
| 削除 | アカウント削除 | user_id | ユーザー削除 |

#### 処理フロー
1. 管理者がユーザー管理にアクセス
2. ユーザー一覧を表示、検索・フィルター
3. 編集ボタンクリックで権限変更
4. 削除ボタンクリックでアカウント削除

---

### 3.21 A-003: システム設定

#### 目的
料金プラン・メール設定

#### 主要機能
- Proプラン料金変更
- メール通知テンプレート編集
- システム全体の設定（メンテナンスモード等）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | システム設定取得 | - | 現在の設定 |
| 更新 | 料金プラン変更 | new_price | Stripe料金更新 |
| 更新 | メールテンプレート編集 | template_id, 内容 | テンプレート更新 |

#### 処理フロー
1. 管理者がシステム設定にアクセス
2. 各設定項目を編集
3. 保存ボタンクリックで更新

---

### 3.22 A-004: データ分析

#### 目的
利用統計・売上レポート

#### 主要機能
- ユーザー登録推移グラフ
- 売上推移グラフ
- 人気機能分析（ペルソナ/テーマ/文章/画像/プロンプト生成の利用率）
- CSV/PDFエクスポート

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 分析データ取得 | 期間指定 | 統計データ |
| 作成 | レポートエクスポート | 期間、形式（CSV/PDF） | ダウンロードファイル |

#### 処理フロー
1. 管理者がデータ分析にアクセス
2. 期間を指定してデータ取得
3. グラフ・表で可視化
4. エクスポートボタンクリックでダウンロード

---

### 3.23 A-005: サポート管理

#### 目的
問い合わせ・フィードバック対応

#### 主要機能
- 問い合わせ一覧表示
- フィードバック一覧表示
- ステータス管理（未対応/対応中/完了）
- 返信機能
- 検索・フィルター

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 問い合わせ一覧取得 | - | 全問い合わせ |
| 取得 | フィードバック一覧取得 | - | 全フィードバック |
| 更新 | ステータス更新 | inquiry_id, new_status | ステータス更新 |
| 作成 | 返信送信 | inquiry_id, 返信内容 | ユーザーにメール送信 |

#### 処理フロー
1. 管理者がサポート管理にアクセス
2. 問い合わせ/フィードバック一覧を表示
3. 詳細を確認、ステータス更新
4. 返信ボタンクリックで返信フォーム表示
5. 返信内容を入力、送信
6. ユーザーにメール通知

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
User:
  概要: ユーザーアカウント情報
  主要属性:
    - 基本情報: user_id, name, email, password_hash, oauth_provider, oauth_id
    - 設定情報: openai_api_key（暗号化）, wordpress_url, wordpress_app_password
    - メタ情報: role（user/admin）, created_at, updated_at
  関連:
    - Subscription（1対1）
    - Projects（1対多: PersonaProject, ThemeProject, ArticleProject, ImageProject, PromptProject）

Subscription:
  概要: サブスクリプション情報
  主要属性:
    - user_id（外部キー）
    - stripe_customer_id
    - stripe_subscription_id
    - plan（trial/pro）
    - status（active/canceled/past_due）
    - trial_ends_at
    - current_period_start
    - current_period_end
  関連:
    - User（1対1）

PersonaProject:
  概要: ペルソナ生成プロジェクト
  主要属性:
    - project_id, user_id, persona_type（自分/ターゲット）, name, data（JSON）
    - is_deleted, created_at, updated_at
  関連:
    - User（多対1）
    - ArticleProject（1対多: 執筆者/ターゲット参照）

ThemeProject:
  概要: テーマ生成プロジェクト
  主要属性:
    - project_id, user_id, source_type, source_data, persona_id（オプション）
    - theme_count, expertise_level, themes（JSON配列）
    - is_deleted, created_at, updated_at
  関連:
    - User（多対1）
    - PersonaProject（多対1、オプション）
    - ArticleProject（1対多: テーマ参照）

ArticleProject:
  概要: 文章生成プロジェクト
  主要属性:
    - project_id, user_id, genre, tone, theme, theme_id（参照）
    - author_persona_id, target_persona_id, seo_keywords, seo_meta_description
    - content（HTML）, images（URL配列）
    - wordpress_url, wordpress_status, wordpress_category_id, wordpress_permalink, wordpress_featured_image
    - is_deleted, created_at, updated_at
  関連:
    - User（多対1）
    - ThemeProject（多対1、オプション）
    - PersonaProject（多対2: 執筆者/ターゲット、オプション）

ImageProject:
  概要: 画像生成プロジェクト
  主要属性:
    - project_id, user_id, style, aspect_ratio, prompt, image_url
    - variants（JSON配列）
    - is_deleted, created_at, updated_at
  関連:
    - User（多対1）

PromptProject:
  概要: プロンプト生成プロジェクト
  主要属性:
    - project_id, user_id, purpose, prompt
    - is_deleted, created_at, updated_at
  関連:
    - User（多対1）

Inquiry:
  概要: 問い合わせ
  主要属性:
    - inquiry_id, user_id, category, subject, body, status（未対応/対応中/完了）
    - created_at, updated_at
  関連:
    - User（多対1）

Feedback:
  概要: フィードバック
  主要属性:
    - feedback_id, user_id, category, title, body, status（未対応/対応中/完了）
    - created_at, updated_at
  関連:
    - User（多対1）
```

### 4.2 エンティティ関係図
```
User ─┬─ Subscription        （1対1）
      ├─ PersonaProject      （1対多）
      ├─ ThemeProject        （1対多）
      ├─ ArticleProject      （1対多）
      ├─ ImageProject        （1対多）
      ├─ PromptProject       （1対多）
      ├─ Inquiry             （1対多）
      └─ Feedback            （1対多）

PersonaProject ─── ArticleProject （1対多: 執筆者/ターゲット参照）

ThemeProject ─┬─ PersonaProject  （多対1、オプション）
              └─ ArticleProject  （1対多: テーマ参照）
```

### 4.3 バリデーションルール
```yaml
email:
  - ルール: 有効なメール形式、ユニーク
  - 理由: ユーザー識別とログインのため

password:
  - ルール: 8文字以上、英数字混在
  - 理由: セキュリティ確保のため

openai_api_key:
  - ルール: sk-で始まる文字列、暗号化保存
  - 理由: OpenAI API認証とセキュリティのため

wordpress_app_password:
  - ルール: 非空文字列、暗号化保存
  - 理由: WordPress REST API認証とセキュリティのため

project_name:
  - ルール: 1〜100文字
  - 理由: UI表示とデータベース制約のため

theme_count:
  - ルール: 1〜10
  - 理由: API負荷とユーザー体験のバランス

file_upload:
  - ルール: 最大20MB、対応形式のみ
  - 理由: サーバー負荷とセキュリティのため
```

## 5. 制約事項

### 外部API制限
- **OpenAI API（ユーザー負担）**:
  - Rate Limit: 使用量ティア制度（Tier 1: 500K TPM、Tier 2: 1M TPM等）
  - ファイルサイズ: PDF 50MB/ファイル、音声 25MB/ファイル
  - 画像生成: 1リクエスト1枚のみ（2パターン生成は2回の並列リクエスト）
- **WordPress REST API**:
  - サーバー設定による（通常2MB〜8MB）
  - 共有ホスティングでは同時接続数制限あり
- **Stripe**:
  - 決済手数料4.1%（決済3.6% + サブスク管理0.5%）

### 技術的制約
- **ファイルアップロード**: アプリケーション層10-20MB、Webサーバー層50-100MB
- **音声文字起こし**: Whisper API 25MB制限、超過時は圧縮または分割処理
- **画像生成**: GPT Image 1.5は1リクエスト1枚、バリエーション生成非対応
- **WordPressテーマ自動判定**: 不可能（ユーザー手動指定またはプリセット方式）

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

CVSS 3.1の評価観点:
- **機密性（Confidentiality）**: 不正アクセス防止、データ暗号化
- **完全性（Integrity）**: データ改ざん防止、入力検証
- **可用性（Availability）**: DoS対策、冗長化

詳細な診断と改善は、Phase 11（本番運用診断）で @本番運用診断オーケストレーター が実施します。

---

### プロジェクト固有の必須要件

**認証機能（必須）**:
- ✅ ブルートフォース攻撃対策（アカウントロックアウト: 5回失敗で30分ロック）
- ✅ パスワードポリシー（8文字以上、英数字混在）
- ✅ セッション管理（タイムアウト: 24時間、CSRF対策: Auth.js v5標準実装）

**決済機能（必須）**:
- ✅ PCI DSS準拠（Stripe利用で自動対応）
- ✅ トランザクションログ記録（Webhook経由）

**ファイルアップロード機能（必須）**:
- ✅ ファイルタイプ検証（MIMEタイプ、拡張子ホワイトリスト、マジックバイト）
- ✅ ファイルサイズ制限（10-20MB）
- ✅ マルウェアスキャン（本番環境、ClamAV推奨）

**APIキー管理（必須）**:
- ✅ OpenAI APIキー暗号化保存（AES-256-GCM）
- ✅ WordPress Application Password暗号化保存（AES-256-GCM）
- ✅ APIキー漏洩防止（環境変数管理、ログ出力禁止）

**その他の一般要件**:
- ✅ HTTPSの強制（本番環境）
- ✅ セキュリティヘッダー設定（本番環境: CSP, X-Frame-Options, X-Content-Type-Options等）
- ✅ 入力値のサニタイゼーション（XSS対策）
- ✅ エラーメッセージでの情報漏洩防止（スタックトレース非表示）

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント（全プロジェクト必須）**:
- エンドポイント: `/api/health`
- 目的: Cloud Run/Kubernetesでのliveness/readinessプローブ
- 要件: データベース接続確認、5秒以内の応答

**グレースフルシャットダウン（全プロジェクト必須）**:
- SIGTERMシグナルハンドラーの実装
- 進行中のリクエスト完了まで待機
- タイムアウト: 8秒（Cloud Runの10秒制限に対応）

## 6. 複合API処理（バックエンド内部処理）

**このセクションは、複雑な処理フローがある場合のみ記載してください。**

### 複合処理-001: 文章生成 → 画像差し込み → WordPress自動投稿

**トリガー**: ユーザーが文章生成ページ（U-007）で「WordPress投稿」ボタンクリック

**フロントエンドAPI**: POST /api/article/wordpress-publish

**バックエンド内部処理**:
1. **文章データ取得** - ArticleProjectからcontent（HTML）、images（URL配列）を取得
2. **アイキャッチ画像アップロード** - WordPress REST API（POST /wp-json/wp/v2/media）で画像をメディアライブラリにアップロード
3. **記事投稿** - WordPress REST API（POST /wp-json/wp/v2/posts）で記事作成、アイキャッチ画像を紐付け
4. **結果保存** - ArticleProjectにwordpress_post_idを保存

**結果**: WordPress投稿成功/失敗（エラー内容）

**外部サービス依存**: WordPress REST API（ユーザー側）

---

### 複合処理-002: 音声ファイル文字起こし → テーマ生成

**トリガー**: ユーザーがテーマ生成ページ（U-005）で音声ファイルをアップロード

**フロントエンドAPI**: POST /api/theme/generate

**バックエンド内部処理**:
1. **音声ファイルアップロード** - 一時ストレージに保存
2. **文字起こし** - OpenAI Whisper API（POST /v1/audio/transcriptions）でテキスト変換
3. **テーマ生成** - OpenAI GPT-4o API（POST /v1/chat/completions）でテーマを複数生成
4. **結果保存** - ThemeProjectに保存

**結果**: テーマリスト（JSON配列）

**外部サービス依存**: OpenAI API（Whisper, GPT-4o、ユーザー側）

---

### 複合処理-003: 画像生成（2パターン並列）

**トリガー**: ユーザーが画像生成ページ（U-009）で「生成」ボタンクリック

**フロントエンドAPI**: POST /api/image/generate

**バックエンド内部処理**:
1. **プロンプト生成** - ユーザー入力（スタイル、縦横比、会話履歴）からプロンプトを生成
2. **画像生成（並列2回）** - OpenAI GPT Image 1.5 API（POST /v1/images/generations）を2回並列実行
3. **結果保存** - ImageProjectにvariantsとして保存

**結果**: 画像URL×2

**外部サービス依存**: OpenAI API（GPT Image 1.5、ユーザー側）

---

## 7. 技術スタック

### フロントエンド
- **フレームワーク**: React 18（Blue Lamp標準）
- **言語**: TypeScript 5
- **UIライブラリ**: MUI v6（Gammaライクなデザイン実現）
- **状態管理**: Zustand（軽量グローバル状態管理）
- **ルーティング**: Next.js 14+ App Router
- **認証**: Auth.js v5（Google OAuth + メール/パスワード）
- **データフェッチ**: React Query
- **ビルドツール**: Vite 5（高速開発サーバー）
- **フォーム管理**: React Hook Form + Zod（バリデーション）
- **リッチテキストエディタ**: Lexical（文章生成の編集機能）
- **ファイルアップロード**: react-dropzone

### バックエンド
- **言語**: Python 3.11+
- **フレームワーク**: FastAPI
- **ORM**: Prisma（型安全、Next.jsと統合）
- **バリデーション**: Pydantic（FastAPI標準）
- **非同期処理**: asyncio
- **API統合**:
  - OpenAI API（GPT-4o, GPT Image 1.5, Whisper、ユーザー側）
  - WordPress REST API（ユーザー側）
  - Stripe API
- **ファイル処理**:
  - pdfplumber（PDF抽出）
  - python-docx（docx抽出）
  - Pillow（画像処理）

### データベース
- **メインDB**: PostgreSQL（Neon推奨）
  - サーバーレスで管理不要
  - 無料枠で十分な容量（0.5GB）
  - 自動スケーリング
  - ブランチ機能で開発/本番分離可能
  - 接続URL: neon.tech

### インフラ
- **フロントエンド**: Vercel
  - Next.js最適化
  - 自動デプロイ
  - エッジキャッシュ
- **バックエンド**: Google Cloud Run（推奨）
  - コンテナベース
  - 自動スケーリング
  - 従量課金（使用量に応じた低コスト）
- **ストレージ**: AWS S3 または Cloudinary
  - 画像・ファイルの永続化
  - CDN配信
- **CI/CD**: GitHub Actions
  - 自動テスト・デプロイ

## 8. 必要な外部サービス・アカウント

### 必須サービス（プラットフォーム運営者側）
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| **Stripe** | サブスクリプション決済、14日間無料トライアル管理 | https://dashboard.stripe.com/register | 手数料4.1% |
| **Google Cloud** | OAuth 2.0認証（Googleログイン用） | https://console.cloud.google.com | 無料 |
| **Neon PostgreSQL** | データベース（ユーザー情報、プロジェクト等） | https://neon.tech | 無料枠0.5GB |
| **Vercel** | フロントエンドホスティング | https://vercel.com | 無料枠あり |
| **Google Cloud Run** | バックエンドホスティング | https://console.cloud.google.com | 従量課金 |
| **AWS S3 または Cloudinary** | 画像ストレージ（生成画像保存） | https://aws.amazon.com または https://cloudinary.com | S3: 低コスト、Cloudinary: 画像最適化 |

### 必須サービス（エンドユーザー側）
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| **OpenAI API** | GPT-4o（ペルソナ・テーマ・文章・プロンプト生成）、GPT Image 1.5（画像生成）、Whisper（音声文字起こし） | https://platform.openai.com | 従量課金（ユーザー負担） |

### オプションサービス（エンドユーザー側）
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| **WordPress** | 自動投稿先（Application Password設定） | ユーザーの既存WordPressサイト | REST API利用 |

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

**拡張候補（実装はしない）**:
- テンプレート機能（構想未確定）
- 2段階認証（2FA）
- チーム機能（複数ユーザーでプロジェクト共有）
- プロジェクト公開設定（他ユーザーとの共有）
- WordPress以外のCMS自動投稿（Medium, note等）
- AIモデル選択機能（GPT-4o以外のモデル対応）
